<ion-content>

  <ion-grid>
    <form [formGroup]="createEventForm" (submit)="onSubmit()" enctype="multipart/form-data"> 
      
      <ion-row class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12">
          <div class="ion-text-start">
            <!-- {{ createEventForm.value | json }} -->
            <h3 class="mt-0">Создание мероприятия</h3>
          </div>

          <div class="stepper-progress">
            <ng-container *ngIf="vkGroups">
              <div *ngFor="let step of [].constructor(steps); let i = index" class="stepper-items">
                <ion-button 
                  shape="round" 
                  (click)="goToStep(i + 1)" 
                  [color]="stepCurrency === i + 1 ? 'primary' : !stepIsValid(i + 1) ? 'danger' : 'light'"  
                  [disabled]="vkGroupPostSelected && (i === 3 || i === 4)"
                >
                {{ i + 1 }}
              </ion-button>
              <!-- С зелеными шагами
                <ion-button 
                  shape="round" 
                  (click)="goToStep(i + 1)" 
                  [color]="stepCurrency === i + 1 ? 'primary' : stepCurrency > i + 1 && stepIsValid(i + 1) ? 'success' : !stepIsValid(i + 1) ? 'danger' : 'light'"  
                  [disabled]="vkGroupPostSelected && (i === 3 || i === 4)"
                >
                {{ i + 1 }}
              </ion-button> -->
              </div>
            </ng-container>

            <ng-container *ngIf="!vkGroups">
              <div *ngFor="let step of [].constructor(steps - 2); let i = index" class="stepper-items" >
                <ion-button 
                  shape="round" 
                  (click)="goToStep(i + 3)" 
                  [color]="stepCurrency - 2 === i + 1 ? 'primary' : !stepIsValid(i + 3) && stepCurrency - 2 !== i + 1 ? 'danger' : 'light'"  
                >
                {{ i + 1 }}
              </ion-button>
              <!-- С зелеными шагами
                <ion-button 
                shape="round" 
                (click)="goToStep(i + 3)" 
                [color]="stepCurrency - 2 === i + 1 ? 'primary' : stepCurrency - 2 > i + 1 && stepIsValid(i + 3) ? 'success' : !stepIsValid(i + 3) && stepCurrency - 2 !== i + 1 ? 'danger' : 'light'"  
              >
                {{ i + 1 }}
              </ion-button> -->
              </div>
            </ng-container>
          </div>
          <!-- stepStart {{ stepStart }} stepCurrency {{ stepCurrency }} -->
            <!-- <ion-label>Шаг {{  stepStart === 3 ?  stepCurrency - 2 : stepCurrency }} из {{ vkGroups ? steps : steps - 2 }}</ion-label> -->
        </ion-col>
      </ion-row>
      
        <!-- шаг 1 -->
      <ion-row [hidden]="stepCurrency !== 1" class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 1" @fade>
          <ion-list>

              <ion-list-header>
                <ion-label>Выберите группу, из которой следует загрузить посты</ion-label>
              </ion-list-header>  
              <ion-radio-group *ngIf="vkGroups" (ionChange)="selectedVkGroup($event)" [allowEmptySelection]="true" [value]="vkGroupSelected">
                <ng-container>
                  <ion-item>
                    <ion-avatar>
                      <img alt="ava" src="/assets/icons/favicon.png" />
                    </ion-avatar>
                    <ion-label class="ion-padding-start">Моя страница</ion-label>
                    <ion-radio slot="end" value="{{ user.social_account.provider_id }}"></ion-radio>
                  </ion-item>
                </ng-container>
                <ng-container *ngFor="let group of vkGroups">
                    <ion-item>
                      <ion-avatar>
                        <img alt="ava" src="{{ group.photo_50 }}" />
                      </ion-avatar>
                      <ion-label class="ion-padding-start">{{ group.name }}</ion-label>
                      <ion-radio slot="end" value="-{{ group.id }}"></ion-radio>
                    </ion-item>
                </ng-container>
              </ion-radio-group>

          </ion-list>
        </ion-col>
      </ion-row>

      <!-- шаг 2 -->
      <ion-row  [hidden]="stepCurrency !== 2" class="ion-justify-content-center" >
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 2" @fade>
          <ion-list-header>
            <ion-label>Выберите пост, из которого следует загрузить текст и фото (загружены последние 10 постов). Если вы выберите пост, то шаги 4 и 5 (описание мероприятия и загрузка фото) будут скрыты, так как они автоматически заполнятся из поста.</ion-label>
          </ion-list-header>
          <div *ngIf="vkGroupPosts; else notSelectedGroup">              
            <!-- Скелетна анимация -->
            <ng-container *ngIf="!vkGroupPostsLoaded">
              <ng-container *ngFor="let key of [1,2]">
                <ion-card>
                  
                  <ion-item class="ion-margin-end">
                    <ion-avatar slot="start">
                      <ion-skeleton-text [animated]="true"></ion-skeleton-text>
                    </ion-avatar>
                    <ion-label>
                      <ion-skeleton-text [animated]="true"></ion-skeleton-text>
                    </ion-label>
                  </ion-item>


                  <ion-card-content>
                    <ion-skeleton-text [animated]="true" style="height: 100px;"></ion-skeleton-text>
                  </ion-card-content>

                  <ion-row class="ion-padding-horizontal">
                    <ng-container  *ngFor="let key of [1,2,3]">
                      <ion-col size="4" class="ion-align-self-center ion-justify-content-center">
                        <ion-skeleton-text [animated]="true" style="height: 80px;"></ion-skeleton-text>
                      </ion-col>             
                    </ng-container> 
                  </ion-row>
                  
                </ion-card>
                
              </ng-container>
            </ng-container>

            <ng-container *ngIf="vkGroupPostsLoaded">
              <ng-container *ngFor="let post of vkGroupPosts.items; let i = index">
                <ion-card>
                  <ng-container *ngFor="let profile of vkGroupPosts.profiles; index as i">
                    <ion-item *ngIf="i === 0" class="ion-margin-end">
                      <ion-avatar slot="start">
                        <img alt="ava" src="{{ profile.photo_50 }}" />
                      </ion-avatar>
                      <ion-label>{{ profile.first_name }}</ion-label>
                    </ion-item>
                  </ng-container>

                  <ion-card-content>
                    <app-read-more text="{{ post.text }}"></app-read-more>
                  </ion-card-content>

                  <ion-row *ngIf="post.attachments" class="ion-padding-horizontal">
                    <ng-container  *ngFor="let attachment of post.attachments">
                      <ng-container *ngFor="let photo of attachment.photo.sizes">
                        <ion-col *ngIf="photo.type === 'm'" size="4" class="ion-align-self-center ion-justify-content-center">
                          <img alt="ava" src="{{ photo.url }}" /> 
                        </ion-col>    
                      </ng-container>           
                    </ng-container> 
                  </ion-row>
                  
                  <ion-footer>
                    <div class="ion-text-end">
                      <ion-button (click)="selectedVkGroupPost(post)" class="ion-margin" [color]="vkGroupPostSelected?.id === post.id ? 'success' : 'medium'">
                        <ion-icon *ngIf="vkGroupPostSelected?.id === post.id" name="checkmark-outline" slot="start"></ion-icon>
                        {{ vkGroupPostSelected?.id === post.id ? 'Выбрано' : 'Выбрать'}} 
                      </ion-button>
                    </div>  
                  </ion-footer>
                </ion-card>
                
              </ng-container>
            </ng-container>
          </div>
          
          <ng-template #notSelectedGroup>
            <ion-row>
              <ion-list-header>
                <ion-note color="medium" class="ion-padding-vertical">Вы не выбрали группу, для выбора вернитесь назад и выберите группу (шаг 1)</ion-note>
              </ion-list-header>
            </ion-row>
          </ng-template>
        </ion-col>
      </ion-row>
      
      <!-- шаг 3 -->
      <ion-row  [hidden]="stepCurrency !== 3" class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 3" @fade>
          <ion-item fill="outline">
            <ion-label position="floating">Название мероприятия</ion-label>
            <ion-icon name="text-outline" slot="start" size="small" color="primary"></ion-icon>
            <ion-input formControlName="name" type="text" name="name" required></ion-input>
          </ion-item>
          <div *ngIf="createEventForm.controls['name'].invalid && createEventForm.controls['name'].dirty"  class="validation">
            <ion-note *ngIf="!createEventForm.controls['name'].hasError('minLength')" color="danger">Название мероприятия должно содержать минимум 3 символа</ion-note>
          </div>
        </ion-col>
      </ion-row>
      
      <!-- шаг 4  -->
      <ion-row  [hidden]="stepCurrency !== 4" class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 4" @fade>
          <div *ngIf="createEventForm.controls['description'].invalid && createEventForm.controls['description'].dirty"  class="validation">
            <ion-note *ngIf="!createEventForm.controls['description'].hasError('minLength')" color="danger">поле "Об мероприятии" должно содержать минимум 10 символа</ion-note>
          </div>

          <ion-item>
            <ion-label position="floating">Об мероприятии</ion-label>
            <ion-textarea 
              formControlName="description" 
              placeholder="Введите инфомармацию об мероприятии.." 
              [autoGrow]="true" 
              required
            >
          </ion-textarea>
          </ion-item>
          <!-- <div *ngIf="createEventForm.controls['description'].invalid && createEventForm.controls['description'].dirty "  class="validation">
            <ion-note *ngIf="!createEventForm.controls['description'].hasError('minLength')" color="danger">поле "Об мероприятии" должно содержать минимум 10 символа</ion-note>
          </div> -->
        </ion-col>
      </ion-row>
            
      <!-- шаг 5 -->
      <ion-row  [hidden]="stepCurrency !== 5" class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 5" @fade>
          <!-- <ion-label position="floating">Добавление фотографий (*.png, *.jpeg)</ion-label> -->
          <div *ngIf="!vkGroupPostSelected" class="ion-margin-vertical">
            <div class="upload-overlay ion-activatable custom-parent" (click)="filesUpload.click()">  
              <ion-item lines="none" class="photo-label">
                <ion-icon name="images" slot="start" color="primary"></ion-icon>
                <ion-label color="medium">Выбрать фото (*.png, *.jpeg)</ion-label>
              </ion-item>
              <ion-ripple-effect></ion-ripple-effect>
            </div>
            <input formControlName="files" (change)="onFileChange($event)" type="file" name="files[]" accept="image/png, image/jpeg" hidden multiple #filesUpload>
            
            <ion-note *ngIf="createEventForm.controls['files'].hasError('requiredFileType')" color="danger">Допустимые форматы *.png, *.jpeg</ion-note>

            <!-- Image Preview -->
            <ion-row  *ngIf="imagesPreview">
              <ng-container *ngFor="let img of imagesPreview">
                <ion-col size="4" class="ion-align-self-center ion-justify-content-center">
                  <img [src]="img" alt="preview">
                  <ion-button size="small" color="danger" expand="block" (click)="deleteFile(img)">
                    <ion-icon name="trash-bin" slot="start"></ion-icon>
                    Удалить
                  </ion-button>
                </ion-col>    
              </ng-container>    
            </ion-row>
          </div>

          <ion-row *ngIf="vkGroups && vkGroupPostSelected && vkGroupPostSelected.attachments.length" class="ion-padding-horizontal">
            <ng-container  *ngFor="let attachment of vkGroupPostSelected.attachments">
              <ng-container *ngFor="let photo of attachment.photo.sizes">
                <ion-col *ngIf="photo.type === 'm'" size="4" class="ion-align-self-center ion-justify-content-center">
                  <img alt="ava" src="{{ photo.url }}" /> 
                </ion-col>     
              </ng-container>  
            </ng-container> 
          </ion-row>

          <ion-row *ngIf="vkGroups && vkGroupPostSelected && !vkGroupPostSelected.attachments.length" class="ion-padding-vertical">
            <ion-col class="ion-align-self-center ion-justify-content-center">
              <ion-label color="medium">В выбранном посте нету фотографиий</ion-label>
            </ion-col> 
          </ion-row>

          <!-- <ion-row *ngIf="vkGroups && !vkGroupPostSelected" class="ion-padding-vertical">
            <ion-col class="ion-align-self-center ion-justify-content-center">
              <ion-label color="medium">Вы не выбрали пост, невозможно подгрузить фотографии</ion-label>
            </ion-col> 
          </ion-row> -->
        </ion-col>
      </ion-row>
      
      <!-- шаг 6 -->
      <ion-row  [hidden]="stepCurrency !== 6" class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 6" @fade>
          <div *ngIf="createEventForm.hasError('dateInvalid')">
            <ion-note color="danger">Дата начала не может быть позднее даты конца, а дата конца не может быть раньше даты начала</ion-note>
          </div>
          <ion-list-header><ion-label>Начало мероприятия: </ion-label></ion-list-header>
          <ion-datetime-button 
            datetime="eventStart" 
            class="ion-margin-vertical"
          ></ion-datetime-button>

          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime 
                id="eventStart" 
                [firstDayOfWeek]="1" 
                [showDefaultButtons]="true"
                doneText="Ok"
                cancelText="Отмена"
                locale="ru-RU"
                formControlName="dateStart"
                ></ion-datetime>
            </ng-template>
          </ion-modal>

          <ion-list-header><ion-label>Конец мероприятия: </ion-label></ion-list-header>

          <ion-datetime-button 
            datetime="eventEnd" 
            class="ion-margin-vertical"
          ></ion-datetime-button>

          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime 
                id="eventEnd"  
                [firstDayOfWeek]="1" 
                [showDefaultButtons]="true"
                doneText="Ok"
                cancelText="Отмена"
                locale="ru-RU"
                formControlName="dateEnd"
              ></ion-datetime>
            </ng-template>
          </ion-modal>

        </ion-col>
      </ion-row>
      
      <!-- шаг 7 -->
      <ion-row  [hidden]="stepCurrency !== 7" class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 7" @fade>
          <ion-item fill="outline">
            <ion-label position="floating">Организатор мероприятия</ion-label>
            <ion-icon name="text-outline" slot="start"  size="small" color="primary"></ion-icon>
            <ion-input formControlName="sponsor"  type="text" name="sponsor" required></ion-input>
          </ion-item>
          <div *ngIf="createEventForm.controls['sponsor'].invalid && createEventForm.controls['sponsor'].dirty"  class="validation">
            <ion-note *ngIf="!createEventForm.controls['sponsor'].hasError('minLength')" color="danger">поле "Организатор мероприятия" должно содержать минимум 3 символа</ion-note>
          </div>
        </ion-col>
      </ion-row>
      
      
      <!-- шаг 8 -->
      <ion-row  [hidden]="stepCurrency !== 8" class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 8" @fade>
          <ion-list>
          <ion-radio-group formControlName="type" (ionChange)="selectedType($event)" [value]="typeSelected" required>
            <ion-list-header>
              <ion-label>Выберите тип мероприятия</ion-label>
            </ion-list-header>

            <ng-container *ngIf="!typesLoaded">
              <ng-container *ngFor="let key of [1,2,3,4,5,6,7,8,9,10]">
                <ion-item>
                  <ion-avatar>
                    <ion-skeleton-text [animated]="true"></ion-skeleton-text>
                  </ion-avatar>
                  <ion-label class="ion-padding-start">
                    <ion-skeleton-text [animated]="true"></ion-skeleton-text>
                  </ion-label>
                </ion-item>
              </ng-container>
            </ng-container>

            <ng-container *ngIf="typesLoaded">
              <ng-container *ngFor="let type of types">
                <ion-item>
                  <img alt="ava" src="{{host}}:{{port}}{{type.ico}}" width="40px" height="40px"/>
                  <ion-label class="ion-padding-start">{{ type.name }}</ion-label>
                  <ion-radio slot="end" value="{{ type.id }}"></ion-radio>
                </ion-item>
              </ng-container>
            </ng-container>
            
          </ion-radio-group>
        </ion-list>
        </ion-col>
      </ion-row>
      
      <!-- шаг 9 -->
      <ion-row  [hidden]="stepCurrency !== 9" class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 9" @fade>
          <ion-list-header>
            <ion-label>На карте выберите место проведения мероприятия или введите адрес в поле поиска</ion-label>
          </ion-list-header>
          
          <ion-item fill="outline" class="ion-margin-vertical">
            <ion-label position="floating">Поиск по адресу</ion-label>
            <ion-icon name="text-outline" slot="start"  size="small" color="primary"></ion-icon>
            <ion-input formControlName="address" (ionChange)="clearSearche($event)" id="search-map" type="text" name="search" value="{{this.createEventForm.value.address}}"  required></ion-input>
          </ion-item>

          <div class="map">
            <ya-map (ready)="onMapReady($event)" 
              [zoom]="11"
              (yaclick)="onMapClick($event)"
              [center]="[56.81497464978607, 61.32053375244141]"
              [state]="{
                controls: [
                  'zoomControl',
                  'fullscreenControl',]
                }" 
            >
            </ya-map>
          </div>
    
          </ion-col>
      </ion-row>
      
      <!-- шаг 10 -->
      <ion-row  [hidden]="stepCurrency !== 10" class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 10" @fade>
          <ion-item fill="outline">
            <ion-label position="floating">Стоимость билета</ion-label>
            <ion-icon name="text-outline" slot="start"  size="small" color="primary"></ion-icon>
            <ion-input formControlName="price" type="number" name="price"></ion-input>
          </ion-item>
        </ion-col>
      </ion-row>
      
      <!-- шаг 11 -->
      <ion-row  [hidden]="stepCurrency !== 11" class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 11" @fade>
          <ion-item>
            <ion-label position="floating" class="position-label-inside">Доп. материалы</ion-label>
            <ion-textarea formControlName="materials" placeholder="Cсылки на фото, пост вк, оплату билетов и.т.д..." [autoGrow]="true"></ion-textarea>
          </ion-item>
        </ion-col>
      </ion-row>

      <!-- шаг 12 -->
      <ion-row  [hidden]="stepCurrency !== 12" class="ion-justify-content-center">
        <ion-col size-lg="4" size-md="8" size-xs="12" *ngIf="stepCurrency === 12" @fade>
          <ion-list>
            <ion-radio-group formControlName="status" (ionChange)="selectedStatus($event)" [value]="statusSelected" required>
              <ng-container *ngIf="!statusesLoaded">
                <ng-container *ngFor="let key of [1,2,3,4,5]">
                  <ion-item>
                    <ion-avatar>
                      <ion-skeleton-text [animated]="true"></ion-skeleton-text>
                    </ion-avatar>
                    <ion-label class="ion-padding-start">
                      <ion-skeleton-text [animated]="true"></ion-skeleton-text>
                    </ion-label>
                  </ion-item>
                </ng-container>
              </ng-container>

              <ng-container *ngIf="statusesLoaded">
                <ng-container *ngFor="let status of statuses">
                  <ion-item *ngIf="status.name === 'На модерации'">
                    <ion-icon name="checkmark-done" slot="start" color="success" size="large"></ion-icon>
                    <ion-label>Отправить на модерацию</ion-label>
                    <ion-radio slot="end" [value]="status.id"></ion-radio>
                  </ion-item>
                  <ion-item *ngIf="status.name === 'Черновик'">
                    <ion-icon name="create" slot="start" color="medium" size="large"></ion-icon>
                    <ion-label>Оставить в черновиках</ion-label>
                    <ion-radio slot="end" [value]="status.id"></ion-radio>
                  </ion-item>
                </ng-container>
              </ng-container>
              
            </ion-radio-group>
          </ion-list>
        </ion-col>
      </ion-row>

       <!-- Декстопный блок кнопок -->
      <div class="buttons-dekstop">
        <ion-row class="ion-justify-content-around">
          <ion-col size-lg="2" size-md="4" class="left">
            <ion-button *ngIf="stepCurrency !== stepStart"  (click)="stepPrev()"><ion-icon name="chevron-back" slot="start"></ion-icon>Назад</ion-button>
          </ion-col>
          <ion-col size-lg="2" size-md="4">
            <ion-button *ngIf="stepCurrency !== steps"  (click)="stepNext()">Далее <ion-icon name="chevron-forward" slot="end"></ion-icon></ion-button>
            <ion-button *ngIf="stepCurrency === steps" type="submit" [disabled] ="createEventForm.invalid || createEventForm.disabled"><ion-icon name="checkmark-done-outline" slot="start"></ion-icon>Готово</ion-button>
          </ion-col>     
        </ion-row>
      </div>

      <!-- Фиксированный блок кнопок для мобилы-->
      <div class="buttons-mobile">
        <ion-row class="ion-justify-content-center">
          <ion-col size="6">
            <ion-button *ngIf="stepCurrency !== stepStart"  (click)="stepPrev()" expand="block"><ion-icon name="chevron-back" slot="start"></ion-icon>Назад</ion-button>
          </ion-col>
          <ion-col size="6">
            <ion-button *ngIf="stepCurrency !== steps"  (click)="stepNext()" expand="block">Далее <ion-icon name="chevron-forward" slot="end"></ion-icon></ion-button>
            <ion-button *ngIf="stepCurrency === steps" type="submit" [disabled] ="createEventForm.invalid || createEventForm.disabled" expand="block"><ion-icon name="checkmark-done-outline" slot="start"></ion-icon>Готово</ion-button>
          </ion-col>     
        </ion-row>
      </div>

    </form>
  </ion-grid>

</ion-content>